<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.3.4.min.js"></script>
    <script src="amazon-cognito.min.js"></script>
    <script src="ENV.js"></script>

    <title></title>
    <style>
        button {
            display: none;
        }

        .no-token .get, .token .use {
            display: inline;
        }
    </style>
</head>
<body class="no-token">
    <a href="index.html">Refresh Page</a>
    <button class="get">Get Token</button>
    <button class="use">Use Token</button>
    <pre class="results"></pre>

    <script>
        var token;

        if (window.location.hash) {
            token = processTokenCallback();
        }

        if (token) {
            document.querySelector("body").className = "token";
        }

        document.querySelector(".get").addEventListener("click", getToken, false);
        document.querySelector(".use").addEventListener("click", useToken, false);

        function show(data) {
            document.querySelector(".results").textContent += JSON.stringify(data, null, 2);
            document.querySelector(".results").textContent += '\r\n';
        }
        function clear() {
            document.querySelector(".results").textContent = "";
        }

        function getToken() {
            var authorizationUrl = ENV.authorizationUrl;
            var client_id = 'implicitclient';
            var redirect_uri = ENV.redirectUrl;
            var response_type = "token";
            var scope = "write";
            var state = Date.now() + "" + Math.random();

            localStorage["state"] = state;

            var url =
                authorizationUrl + "?" +
                "client_id=" + encodeURI(client_id) + "&" +
                "redirect_uri=" + encodeURI(redirect_uri) + "&" +
                "response_type=" + encodeURI(response_type) + "&" +
                "scope=" + encodeURI(scope) + "&" +
                "state=" + encodeURI(state);
            window.location = url;
        }

        function processTokenCallback() {
            var hash = window.location.hash.substr(1);
            var result = hash.split('&').reduce(function (result, item) {
                var parts = item.split('=');
                result[parts[0]] = parts[1];
                return result;
            }, {});

            show(result);

            requestAwsCredentialsForOAuthToken( result.access_token );

            if (!result.error) {
                if (result.state !== localStorage["state"]) {
                    show("invalid state");
                }
                else {
                    localStorage.removeItem("state");
                    return result.access_token;
                }
            }
        }

        /**
         * Use AWS Cognito to exchange the given Token for (temporary) AWS credentials
         */
        function requestAwsCredentialsForOAuthToken( OAuthAccessToken ) {
            console.log( "awsCredentialInit()" );

            AWS.config.region = 'ap-northeast-1';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: ENV.IdentityPoolId,
                Logins: {
                    [ ENV.IdentityPoolId ] : OAuthAccessToken
                }
            });

            // Obtain AWS credentials
            AWS.config.credentials.get( receiveAwsCredentials );
        }

        /**
         * Callback once we've received AWS credentials
         */
        function receiveAwsCredentials( err ) {
            console.log( "receiveAwsCredentials()" );
            if ( err ) {
                show( err )
            } else {
                show({
                    identityId      : AWS.config.credentials.identityId,
                    accessKeyId     : AWS.config.credentials.accessKeyId,
                    secretAccessKey : AWS.config.credentials.secretAccessKey,
                    sessionToken    : AWS.config.credentials.sessionToken,
                });
                
                try { doCognitioData(); } catch ( e ) { show(e); }
                try { doDynamoData(); } catch ( e ) { show(e); }
            }
        }

        /**
         * Writes some data using Cognito Sync
         * Cognito Sync is permissined by default on all accounts
         * You can see the results of this write in the AWS Console.
         */
        function doCognitioData(){
            console.log( "doCognitioData()" );

            var syncClient = new AWS.CognitoSyncManager();
            syncClient.openOrCreateDataset('myDataset', function(err, dataset) {
                dataset.put('myKey', 'myValue', function(err, record){
                    dataset.synchronize({
                        onSuccess: function(data, newRecords) {
                            console.log( "Sync success")
                        }
                    });
                });
            });
        }

        /**
         * Does a scan on the configured Table
         */
        function doDynamoData() {
            console.log( "doDynamoData()" );

            var ddb = new AWS.DynamoDB( { ENV.dynamo.region } );
                        
            ddb.scan({ TableName: ENV.dynamo.tableName }, function (err, data) {
                if (err){
                    show(err);   
                } else {
                    var items = '';
                    for (i = 0; i < data.Count; i++) {
                        show( data.Items[i] );
                    }    
                }
            });
        }


        function useToken() {
            clear();

            var xhr = new XMLHttpRequest();
            xhr.onload = function (e) {
                if (xhr.status >= 400) {
                    show({
                        status: xhr.status,
                        statusText: xhr.statusText,
                        wwwAuthenticate: xhr.getResponseHeader("WWW-Authenticate")
                    });
                }
                else {
                    show(JSON.parse(xhr.response));
                }
            };
            xhr.onerror = function (e) {
                console.log(e, xhr);
                show({ error: "unknown http error" });
            };
            xhr.open("GET", "http://localhost:2727/identity", true);
            xhr.setRequestHeader("Authorization", "Bearer " + token);
            xhr.send();
        }

    </script>
</body>
</html>
